{# geography/templates/admin/geography/geographicplace/change_form.html #}
{% extends "admin/change_form.html" %}
{% load static %}

{% block extrahead %}
    {{ block.super }}
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"
          integrity="sha256-sA+ePHItR3vovmCKtzj1S4PA5jV2E+N3qv96TLyXGns="
          crossorigin=""/>
    <!-- Leaflet JavaScript -->
    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"
            integrity="sha256-QVStzYk4CgOZjK3rYQl9HgHcEmGhlbTrZLTGf3Cw3RM="
            crossorigin=""></script>
    <style>
        #map {
            height: 400px;
            width: 100%;
            margin-bottom: 20px;
        }
    </style>
{% endblock %}

{% block after_field_sets %}
    <div id="map"></div>
{% endblock %}

{% block footer %}
    {{ block.super }}
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Initialize the map
            var initialLat = parseFloat("{{ form.instance.latitude|default:"0" }}");
            var initialLng = parseFloat("{{ form.instance.longitude|default:"0" }}");
            var zoomLevel = (initialLat === 0 && initialLng === 0) ? 2 : 10;

            var map = L.map('map').setView([initialLat, initialLng], zoomLevel);

            // Add OpenStreetMap tiles
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors'
            }).addTo(map);

            // Add a marker if coordinates exist
            var marker = null;
            {% if form.instance.latitude and form.instance.longitude %}
                marker = L.marker([{{ form.instance.latitude }}, {{ form.instance.longitude }}]).addTo(map)
                    .bindPopup("{{ form.instance.get_translated_name }}")
                    .openPopup();
            {% endif %}

            // Handle map clicks
            map.on('click', function(e) {
                var lat = e.latlng.lat.toFixed(6);
                var lng = e.latlng.lng.toFixed(6);

                // Update the latitude and longitude fields
                document.getElementById("id_latitude").value = lat;
                document.getElementById("id_longitude").value = lng;

                // If marker exists, move it. Otherwise, add a new marker.
                if (marker) {
                    marker.setLatLng(e.latlng)
                        .bindPopup("{{ form.instance.get_translated_name }}" || "New Location")
                        .openPopup();
                } else {
                    marker = L.marker(e.latlng).addTo(map)
                        .bindPopup("New Location")
                        .openPopup();
                }
            });
        });
    </script>
{% endblock %}
